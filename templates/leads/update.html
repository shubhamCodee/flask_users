{% extends "base.html" %}

{% block content %}

    <!-- Header & Navigation -->
    <div class="border-b border-darkgray pb-4 mb-8 flex justify-between items-end">
        <div>
            <div class="flex items-center gap-2 text-sm text-secondary mb-2">
                <a href="{{ url_for('lead.view_lead', id=lead.id) }}" class="hover:text-primary transition-colors">Back to View</a>
                <span class="text-darkgray">/</span>
                <span class="text-softgray">Edit Prospect</span>
            </div>
            <h1 class="text-3xl font-bold text-primary tracking-tight">Edit: {{ lead.first_name }} {{ lead.last_name }}</h1>
        </div>
    </div>

    <!-- MAIN FORM -->
    <form action="{{ url_for('lead.update_lead', id=lead.id) }}" autocomplete="off" method="POST">
        
        <div class="bg-[#1E1E1E] border border-darkgray rounded-lg shadow-xl max-w-6xl mx-auto overflow-hidden">
            
            <!-- SECTION 1: IDENTITY & CONTACT -->
            <div class="p-8 border-b border-darkgray">
                <h2 class="text-xs font-bold uppercase tracking-widest text-softgray mb-6">1. Identity & Contact</h2>
                
                <!-- Name Row -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-6">
                    <div class="md:col-span-2">
                        <label class="block text-xs text-secondary mb-1">Salutation</label>
                        <select name="salutation" class="form-input">
                            <option value="Mr." {% if lead.salutation == 'Mr.' %}selected{% endif %}>Mr.</option>
                            <option value="Ms." {% if lead.salutation == 'Ms.' %}selected{% endif %}>Ms.</option>
                            <option value="Mrs." {% if lead.salutation == 'Mrs.' %}selected{% endif %}>Mrs.</option>
                            <option value="Dr." {% if lead.salutation == 'Dr.' %}selected{% endif %}>Dr.</option>
                            <option value="Prof." {% if lead.salutation == 'Prof.' %}selected{% endif %}>Prof.</option>
                        </select>
                    </div>
                    <div class="md:col-span-5">
                        <label class="block text-xs text-secondary mb-1">First Name *</label>
                        <input type="text" name="first_name" required class="form-input" value="{{ lead.first_name or '' }}">
                    </div>
                    <div class="md:col-span-5">
                        <label class="block text-xs text-secondary mb-1">Last Name *</label>
                        <input type="text" name="last_name" required class="form-input" value="{{ lead.last_name or '' }}">
                    </div>
                </div>

                <!-- Contact Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-xs text-secondary mb-1">Primary Email</label>
                        <input type="email" name="email_primary" class="form-input" value="{{ lead.email_primary or '' }}">
                    </div>
                    <div>
                        <label class="block text-xs text-secondary mb-1">Primary Phone</label>
                        <input type="text" name="phone_primary" class="form-input" value="{{ lead.phone_primary or '' }}">
                    </div>
                    <div>
                        <label class="block text-xs text-secondary mb-1">Website</label>
                        <input type="text" name="website" class="form-input" value="{{ lead.website or '' }}">
                    </div>
                    
                    <!-- JSON Fields -->
                    <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-[10px] text-darkgray mb-1">Other Emails (JSON)</label>
                            <textarea name="email_json" rows="1" class="form-textarea font-mono text-xs">{{ lead.email_json or '' }}</textarea>
                        </div>
                        <div>
                            <label class="block text-[10px] text-darkgray mb-1">Other Phones (JSON)</label>
                            <textarea name="phone_json" rows="1" class="form-textarea font-mono text-xs">{{ lead.phone_json or '' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 2: PROFESSIONAL PROFILE -->
            <div class="p-8 border-b border-darkgray bg-[#1a1a1a]">
                <h2 class="text-xs font-bold uppercase tracking-widest text-softgray mb-6">2. Professional Profile</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <div>
                        <label class="block text-xs text-secondary mb-1">Target Account Name</label>
                        <input type="text" name="account_id_name" class="form-input" value="{{ lead.account_id_name or '' }}">
                    </div>

                    <div>
                        <label class="block text-xs text-secondary mb-1">Designation</label>
                        <input type="text" name="designation" class="form-input" value="{{ lead.designation or '' }}">
                    </div>

                    <div>
                        <label class="block text-xs text-secondary mb-1">Department</label>
                        <input type="text" name="department" class="form-input" value="{{ lead.department or '' }}">
                    </div>

                    <div>
                        <label class="block text-xs text-secondary mb-1">Hierarchy Level</label>
                        <input type="text" name="hierarchy" class="form-input" value="{{ lead.hierarchy or '' }}">
                    </div>

                    <div>
                        <label class="block text-xs text-secondary mb-1">Industry</label>
                        <input type="text" name="industry" class="form-input" value="{{ lead.industry or '' }}">
                    </div>

                    <div>
                        <label class="block text-xs text-secondary mb-1">Customer Type</label>
                        <input type="text" name="customer_type" class="form-input" value="{{ lead.customer_type or '' }}">
                    </div>
                </div>
            </div>

            <!-- SECTION 3: PIPELINE & STATUS -->
            <div class="p-8 border-b border-darkgray">
                <h2 class="text-xs font-bold uppercase tracking-widest text-softgray mb-6">3. Pipeline Status</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div>
                        <label class="block text-xs text-secondary mb-1">Status</label>
                        <select name="status" class="form-input">
                            <option value="New" {% if lead.status == 'New' %}selected{% endif %}>New</option>
                            <option value="Contacted" {% if lead.status == 'Contacted' %}selected{% endif %}>Contacted</option>
                            <option value="Qualified" {% if lead.status == 'Qualified' %}selected{% endif %}>Qualified</option>
                            <option value="Negotiation" {% if lead.status == 'Negotiation' %}selected{% endif %}>Negotiation</option>
                            <option value="Converted" {% if lead.status == 'Converted' %}selected{% endif %}>Converted</option>
                            <option value="Lost" {% if lead.status == 'Lost' %}selected{% endif %}>Lost</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-secondary mb-1">Lead Source</label>
                        <input type="text" name="lead_source" class="form-input" value="{{ lead.lead_source or '' }}">
                    </div>
                    <div>
                        <label class="block text-xs text-secondary mb-1">Other Source</label>
                        <input type="text" name="other_source" class="form-input" value="{{ lead.other_source or '' }}">
                    </div>
                    <div>
                        <label class="block text-xs text-secondary mb-1">Product Interest</label>
                        <input type="text" name="product_sub_category" class="form-input" value="{{ lead.product_sub_category or '' }}">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 border-t border-darkgray pt-6">
                    <div>
                        <label class="block text-xs text-secondary mb-1">Next Follow-up Date</label>
                        <!-- Datetime format fix for input value -->
                        <input type="datetime-local" name="next_followup_date" class="form-input" 
                               value="{{ lead.next_followup_date.strftime('%Y-%m-%dT%H:%M') if lead.next_followup_date else '' }}">
                    </div>
                    <div>
                        <label class="block text-xs text-secondary mb-1">Follow-up Type</label>
                        <select name="next_followup_type" class="form-input">
                            <option value="">-- Select --</option>
                            <option value="Call" {% if lead.next_followup_type == 'Call' %}selected{% endif %}>Call</option>
                            <option value="Email" {% if lead.next_followup_type == 'Email' %}selected{% endif %}>Email</option>
                            <option value="Meeting" {% if lead.next_followup_type == 'Meeting' %}selected{% endif %}>Meeting</option>
                            <option value="Demo" {% if lead.next_followup_type == 'Demo' %}selected{% endif %}>Demo</option>
                        </select>
                    </div>
                    <div class="flex items-center h-full pt-4">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" name="converted" value="true" class="w-5 h-5 bg-charcoal border-darkgray rounded accent-primary"
                                   {% if lead.converted %}checked{% endif %}>
                            <span class="text-sm text-green-400 font-bold">Mark as Converted</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- SECTION 4: LOCATION & GEOFENCE -->
            <div class="p-8 border-b border-darkgray bg-[#1a1a1a]">
                <h2 class="text-xs font-bold uppercase tracking-widest text-softgray mb-6">4. Location Data</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="col-span-2">
                        <label class="block text-xs text-secondary mb-1">Street</label>
                        <input type="text" name="street" class="form-input" value="{{ lead.street or '' }}">
                    </div>
                    <div>
                        <label class="block text-xs text-secondary mb-1">Area</label>
                        <input type="text" name="area" class="form-input" value="{{ lead.area or '' }}">
                    </div>
                    <div>
                        <label class="block text-xs text-secondary mb-1">City</label>
                        <input type="text" name="city" class="form-input" value="{{ lead.city or '' }}">
                    </div>
                    <div>
                        <label class="block text-xs text-secondary mb-1">State</label>
                        <input type="text" name="state" class="form-input" value="{{ lead.state or '' }}">
                    </div>
                    <div>
                        <label class="block text-xs text-secondary mb-1">Country</label>
                        <input type="text" name="country" class="form-input" value="{{ lead.country or '' }}">
                    </div>
                    <div>
                        <label class="block text-xs text-secondary mb-1">Postal Code</label>
                        <input type="text" name="postal_code" class="form-input" value="{{ lead.postal_code or '' }}">
                    </div>
                    <div>
                        <label class="block text-xs text-secondary mb-1">Address Type</label>
                        <input type="text" name="address_type" class="form-input" value="{{ lead.address_type or '' }}">
                    </div>
                </div>

                <div class="mt-6 p-4 border border-darkgray rounded bg-[#121212]">
                    <h3 class="text-[10px] font-bold uppercase text-softgray mb-3">Geofencing</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-[10px] text-darkgray mb-1">Latitude</label>
                            <input type="text" name="geofence_latitude" class="form-input-sm" value="{{ lead.geofence_latitude or '' }}">
                        </div>
                        <div>
                            <label class="block text-[10px] text-darkgray mb-1">Longitude</label>
                            <input type="text" name="geofence_longitude" class="form-input-sm" value="{{ lead.geofence_longitude or '' }}">
                        </div>
                        <div>
                            <label class="block text-[10px] text-darkgray mb-1">Radius (Meters)</label>
                            <input type="text" name="geofence_radius" class="form-input-sm" value="{{ lead.geofence_radius or '' }}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 5: SYSTEM & TRACKING -->
            <div class="p-8 border-b border-darkgray">
                <h2 class="text-xs font-bold uppercase tracking-widest text-softgray mb-6">5. System & Assignment</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-xs text-secondary mb-1">Assigned Owner</label>
                        <select name="assigned_user_id" class="form-input">
                            <option value="">-- Unassigned --</option>
                            {% for user in users %}
                                <option value="{{ user.id }}" {% if lead.assigned_user_id == user.id %}selected{% endif %}>
                                    {{ user.username }} ({{ user.email }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-secondary mb-1">Internal Team ID</label>
                        <input type="text" name="team_id" class="form-input" value="{{ lead.team_id or '' }}">
                    </div>
                </div>

                <!-- Advanced Tracking -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 opacity-60 hover:opacity-100 transition-opacity">
                    <div>
                        <label class="block text-[10px] text-secondary mb-1">How Old (Days)</label>
                        <input type="number" name="how_old_days" class="form-input-sm" value="{{ lead.how_old_days or 0 }}">
                    </div>
                    <div>
                        <label class="block text-[10px] text-secondary mb-1">Untouched (Days)</label>
                        <input type="number" name="untouched_since_days" class="form-input-sm" value="{{ lead.untouched_since_days or 0 }}">
                    </div>
                    <div>
                        <label class="block text-[10px] text-secondary mb-1">Lost Reason</label>
                        <input type="text" name="lost_reason" class="form-input-sm" value="{{ lead.lost_reason or '' }}">
                    </div>
                    <div>
                        <label class="block text-[10px] text-secondary mb-1">Closed Date</label>
                        <input type="date" name="closed_date" class="form-input-sm" value="{{ lead.closed_date or '' }}">
                    </div>
                </div>
            </div>

            <!-- SECTION 6: NOTES -->
            <div class="p-8 bg-[#1a1a1a]">
                <h2 class="text-xs font-bold uppercase tracking-widest text-softgray mb-6">6. Remarks</h2>
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label class="block text-xs text-secondary mb-1">Description / Requirements</label>
                        <textarea name="description" rows="3" class="form-textarea">{{ lead.description or '' }}</textarea>
                    </div>
                    <div>
                        <label class="block text-xs text-secondary mb-1">Latest Comment</label>
                        <textarea name="latest_comment" rows="3" class="form-textarea">{{ lead.latest_comment or '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- FOOTER -->
            <div class="p-8 border-t border-darkgray flex justify-end gap-4 bg-charcoal">
                <a href="{{ url_for('lead.view_lead', id=lead.id) }}" class="px-6 py-3 border border-darkgray text-secondary rounded hover:text-primary transition-colors">Cancel</a>
                <button type="submit" class="bg-primary text-charcoal font-bold px-8 py-3 rounded hover:bg-white transition-all shadow-lg">
                    Update Prospect
                </button>
            </div>

        </div>
    </form>

    <!-- STYLES -->
    <style>
        .form-input {
            width: 100%;
            background-color: #121212;
            border: 1px solid #444444;
            color: #E0E0E0;
            padding: 0.75rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }
        .form-input:focus { outline: none; border-color: #888888; }
        
        .form-input-sm {
            width: 100%;
            background-color: #121212;
            border: 1px solid #333333;
            color: #B0B0B0;
            padding: 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }
        .form-input-sm:focus { outline: none; border-color: #666666; }

        .form-textarea {
            width: 100%;
            background-color: #121212;
            border: 1px solid #444444;
            color: #E0E0E0;
            padding: 0.75rem;
            border-radius: 0.25rem;
        }
        .form-textarea:focus { outline: none; border-color: #888888; }
    </style>

{% endblock %}